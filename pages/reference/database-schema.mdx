# Database Schema Reference

This document provides a comprehensive reference for the MOC-IoT PostgreSQL database schema, including table structures, relationships, and Row Level Security (RLS) policies.

## Database Overview

The MOC-IoT system uses Supabase PostgreSQL with the following key characteristics:

- **Project**: `cdwtsrzshpotkfbyyyjk.supabase.co`
- **Authentication**: Supabase Auth with JWT tokens
- **Security**: Row Level Security (RLS) enabled on all tables
- **Real-time**: WebSocket subscriptions for live updates
- **Extensions**: PostGIS for geospatial data (if needed)

## Core Tables

### 1. device_config

Master table containing device configuration and metadata.

```sql
CREATE TABLE device_config (
  devid TEXT PRIMARY KEY,              -- Device identifier (from protobuf dev_id)
  name TEXT,                           -- Human-readable device name
  iccid TEXT,                          -- SIM card ICCID
  heartbeat_interval INTEGER,          -- Heartbeat frequency in seconds
  sw_version TEXT,                     -- Software version string
  hw_version TEXT,                     -- Hardware version string
  application_mode TEXT,               -- Device application mode
  device_data_updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  battery_level INTEGER DEFAULT 0     -- Battery percentage (0-100)
);

-- Indexes for performance
CREATE INDEX idx_device_config_last_seen ON device_config(last_seen DESC);
CREATE INDEX idx_device_config_created_at ON device_config(created_at DESC);
```

**Key Relationships:**
- `devid` is referenced by all other tables
- Updated automatically when heartbeat messages are received

### 2. sensor_data

Flexible table for storing all sensor readings and device data.

```sql
CREATE TABLE sensor_data (
  id BIGSERIAL PRIMARY KEY,
  devid TEXT NOT NULL REFERENCES device_config(devid),
  data_type TEXT NOT NULL,             -- Type of data: 'location', 'temperature', 'wifi_scan', etc.
  data JSONB NOT NULL,                 -- Flexible JSON data storage
  uplink_count INTEGER,                -- Message counter from device
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for efficient queries
CREATE INDEX idx_sensor_data_devid_type ON sensor_data(devid, data_type);
CREATE INDEX idx_sensor_data_created_at ON sensor_data(created_at DESC);
CREATE INDEX idx_sensor_data_uplink_count ON sensor_data(devid, uplink_count);

-- GIN index for JSON queries
CREATE INDEX idx_sensor_data_data ON sensor_data USING GIN (data);
```

**Common data_type values:**
- `location`: GPS coordinates and location data
- `wifi_scan`: WiFi access point information
- `temperature`: Temperature sensor readings
- `soil_data`: Soil moisture, NPK, pH measurements
- `battery`: Battery status and voltage

**Example JSONB data formats:**
```sql
-- Location data
{
  "lat": 55.6761,
  "lng": 12.5683,
  "accuracy": 10.5,
  "source": "here_api",
  "timestamp": "2024-01-15T14:30:00Z"
}

-- WiFi scan data
{
  "access_points": [
    {"mac": "AA:BB:CC:DD:EE:FF", "rssi": -45},
    {"mac": "11:22:33:44:55:66", "rssi": -67}
  ],
  "scan_duration_ms": 5000
}

-- Temperature data
{
  "value": 23.5,
  "unit": "celsius",
  "sensor_id": "internal_temp"
}
```

### 3. activity

Power consumption and device activity tracking.

```sql
CREATE TABLE activity (
  id BIGSERIAL PRIMARY KEY,
  devid TEXT NOT NULL REFERENCES device_config(devid),
  sleep_duration INTEGER DEFAULT 0,    -- Sleep time in seconds
  modem_duration INTEGER DEFAULT 0,    -- Modem active time in seconds
  gnss_duration INTEGER DEFAULT 0,     -- GNSS active time in seconds
  wifi_duration INTEGER DEFAULT 0,     -- WiFi scanning time in seconds
  other_duration INTEGER DEFAULT 0,    -- Other activities in seconds
  uplink_count INTEGER,               -- Message counter
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_activity_devid_created ON activity(devid, created_at DESC);
CREATE INDEX idx_activity_created_at ON activity(created_at DESC);
```

### 4. reboot

Device reboot and crash event tracking.

```sql
CREATE TABLE reboot (
  id BIGSERIAL PRIMARY KEY,
  devid TEXT NOT NULL REFERENCES device_config(devid),
  reason TEXT NOT NULL,                -- Reboot reason: 'SOFTWARE', 'ASSERT', 'WATCHDOG', etc.
  file TEXT,                          -- Source file (if crash)
  line INTEGER,                       -- Line number (if crash)
  uplink_count INTEGER,              -- Message counter
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Index for querying recent reboots
CREATE INDEX idx_reboot_devid_created ON reboot(devid, created_at DESC);
CREATE INDEX idx_reboot_reason ON reboot(reason);
```

### 5. user_roles

User access control and permissions.

```sql
CREATE TABLE user_roles (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id),
  role TEXT NOT NULL,                  -- 'developer', 'admin', 'moderator', 'user'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  UNIQUE(user_id)                     -- One role per user
);

-- Index for role-based queries
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role ON user_roles(role);
```

**Role Hierarchy:**
- `admin`: Full access to all data and user management
- `moderator`: Read/write access to device data, limited user management
- `developer`: Full access to development tools and documentation
- `user`: Read-only access to device data

## Row Level Security (RLS) Policies

### device_config Policies

```sql
-- Enable RLS
ALTER TABLE device_config ENABLE ROW LEVEL SECURITY;

-- Admin/Moderator/Developer full access
CREATE POLICY "admin_moderator_dev_all_access" ON device_config
  FOR ALL TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_roles 
      WHERE user_id = auth.uid() 
      AND role IN ('admin', 'moderator', 'developer')
    )
  );

-- Users can view all devices (read-only)
CREATE POLICY "user_read_access" ON device_config
  FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_roles 
      WHERE user_id = auth.uid() 
      AND role = 'user'
    )
  );
```

### sensor_data Policies

```sql
-- Enable RLS
ALTER TABLE sensor_data ENABLE ROW LEVEL SECURITY;

-- Admin/Moderator/Developer full access
CREATE POLICY "admin_moderator_dev_sensor_data" ON sensor_data
  FOR ALL TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_roles 
      WHERE user_id = auth.uid() 
      AND role IN ('admin', 'moderator', 'developer')
    )
  );

-- Users read-only access
CREATE POLICY "user_read_sensor_data" ON sensor_data
  FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_roles 
      WHERE user_id = auth.uid() 
      AND role = 'user'
    )
  );
```

### activity and reboot Policies

```sql
-- Similar RLS policies for activity and reboot tables
ALTER TABLE activity ENABLE ROW LEVEL SECURITY;
ALTER TABLE reboot ENABLE ROW LEVEL SECURITY;

-- Admin/Moderator/Developer policies
CREATE POLICY "admin_moderator_dev_activity" ON activity FOR ALL TO authenticated
  USING (EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role IN ('admin', 'moderator', 'developer')));

CREATE POLICY "admin_moderator_dev_reboot" ON reboot FOR ALL TO authenticated
  USING (EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role IN ('admin', 'moderator', 'developer')));

-- User read-only policies
CREATE POLICY "user_read_activity" ON activity FOR SELECT TO authenticated
  USING (EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role = 'user'));

CREATE POLICY "user_read_reboot" ON reboot FOR SELECT TO authenticated
  USING (EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role = 'user'));
```

### user_roles Policies

```sql
-- Enable RLS
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;

-- Admins can manage all user roles
CREATE POLICY "admin_manage_roles" ON user_roles
  FOR ALL TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM user_roles 
      WHERE user_id = auth.uid() 
      AND role = 'admin'
    )
  );

-- Users can view their own role
CREATE POLICY "user_own_role" ON user_roles
  FOR SELECT TO authenticated
  USING (user_id = auth.uid());
```

## Useful Queries

### Device Status Overview

```sql
-- Get device status with latest activity
SELECT 
  dc.devid,
  dc.name,
  dc.last_seen,
  dc.battery_level,
  dc.sw_version,
  CASE 
    WHEN dc.last_seen > NOW() - INTERVAL '1 hour' THEN 'online'
    WHEN dc.last_seen > NOW() - INTERVAL '24 hours' THEN 'recent'
    ELSE 'offline'
  END AS status
FROM device_config dc
ORDER BY dc.last_seen DESC;
```

### Latest Location Data

```sql
-- Get latest location for each device
SELECT DISTINCT ON (devid)
  devid,
  data->'lat' AS latitude,
  data->'lng' AS longitude,
  data->'accuracy' AS accuracy,
  created_at
FROM sensor_data
WHERE data_type = 'location'
ORDER BY devid, created_at DESC;
```

### Power Consumption Analysis

```sql
-- Average power consumption by device
SELECT 
  devid,
  AVG(sleep_duration) AS avg_sleep,
  AVG(modem_duration) AS avg_modem,
  AVG(gnss_duration) AS avg_gnss,
  AVG(wifi_duration) AS avg_wifi,
  COUNT(*) AS message_count
FROM activity
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY devid
ORDER BY avg_modem + avg_gnss + avg_wifi DESC;
```

### Recent Reboot Events

```sql
-- Recent reboot events with device info
SELECT 
  r.devid,
  dc.name,
  r.reason,
  r.file,
  r.line,
  r.created_at
FROM reboot r
JOIN device_config dc ON r.devid = dc.devid
WHERE r.created_at > NOW() - INTERVAL '30 days'
ORDER BY r.created_at DESC;
```

### WiFi Network Analysis

```sql
-- Most frequently detected WiFi networks
SELECT 
  ap->>'mac' AS mac_address,
  COUNT(*) AS detection_count,
  AVG((ap->>'rssi')::integer) AS avg_rssi,
  MIN(created_at) AS first_seen,
  MAX(created_at) AS last_seen
FROM sensor_data,
LATERAL jsonb_array_elements(data->'access_points') AS ap
WHERE data_type = 'wifi_scan'
  AND created_at > NOW() - INTERVAL '7 days'
GROUP BY ap->>'mac'
HAVING COUNT(*) > 5
ORDER BY detection_count DESC;
```

## Database Maintenance

### Regular Maintenance Tasks

```sql
-- Clean old sensor data (older than 2 years)
DELETE FROM sensor_data 
WHERE created_at < NOW() - INTERVAL '2 years';

-- Clean old activity logs (older than 1 year)
DELETE FROM activity 
WHERE created_at < NOW() - INTERVAL '1 year';

-- Update statistics for query optimization
ANALYZE device_config;
ANALYZE sensor_data;
ANALYZE activity;
ANALYZE reboot;
```

### Performance Monitoring

```sql
-- Check table sizes
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Check index usage
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

## Data Migration Scripts

### Add New Device

```sql
-- Function to add a new device
CREATE OR REPLACE FUNCTION add_device(
  device_id TEXT,
  device_name TEXT DEFAULT NULL,
  initial_config JSONB DEFAULT '{}'::jsonb
) RETURNS VOID AS $$
BEGIN
  INSERT INTO device_config (devid, name, created_at)
  VALUES (device_id, COALESCE(device_name, 'Device ' || device_id), NOW())
  ON CONFLICT (devid) DO NOTHING;
END;
$$ LANGUAGE plpgsql;

-- Usage
SELECT add_device('12345', 'Test Device');
```

### Update Device Configuration

```sql
-- Function to update device configuration from heartbeat
CREATE OR REPLACE FUNCTION update_device_config(
  device_id TEXT,
  config_data JSONB
) RETURNS VOID AS $$
BEGIN
  UPDATE device_config SET
    iccid = COALESCE(config_data->>'iccid', iccid),
    heartbeat_interval = COALESCE((config_data->>'heartbeat_interval')::integer, heartbeat_interval),
    sw_version = COALESCE(config_data->>'sw_version', sw_version),
    hw_version = COALESCE(config_data->>'hw_version', hw_version),
    device_data_updated_at = NOW(),
    last_seen = NOW()
  WHERE devid = device_id;
  
  -- Create device if it doesn't exist
  IF NOT FOUND THEN
    INSERT INTO device_config (devid, iccid, heartbeat_interval, sw_version, hw_version, created_at, last_seen)
    VALUES (
      device_id,
      config_data->>'iccid',
      (config_data->>'heartbeat_interval')::integer,
      config_data->>'sw_version',
      config_data->>'hw_version',
      NOW(),
      NOW()
    );
  END IF;
END;
$$ LANGUAGE plpgsql;
```

## Backup and Recovery

### Database Backup

```bash
# Full database backup
pg_dump "postgresql://postgres:password@db.cdwtsrzshpotkfbyyyjk.supabase.co:5432/postgres" > moc_iot_backup.sql

# Schema-only backup
pg_dump --schema-only "postgresql://..." > schema_backup.sql

# Data-only backup
pg_dump --data-only "postgresql://..." > data_backup.sql
```

### Point-in-Time Recovery

```bash
# Restore from backup
psql "postgresql://..." < moc_iot_backup.sql

# Restore specific table
pg_restore --table=sensor_data moc_iot_backup.sql
```

This comprehensive database schema reference provides all the information needed to understand, query, and maintain the MOC-IoT database system.
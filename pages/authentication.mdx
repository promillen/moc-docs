# Authentication System

The MOC-IoT documentation site uses a role-based authentication system to restrict access to developer documentation. This page explains how the authentication works, the user flow, and the technical implementation.

## Overview

The documentation site requires users to have a **developer role** in the main MOC-IoT system to access the documentation. This ensures that only authorized developers can view sensitive system information.

## Authentication Flow

### 1. Access Control
- All pages (except `/login`) require authentication
- Unauthenticated users are automatically redirected to the login page
- The redirect preserves the originally requested URL

### 2. Login Process
1. **User Authentication**: Uses Supabase Auth with email/password
2. **Role Verification**: Checks the `user_roles` table for developer permissions
3. **Session Management**: Establishes a client-side session for the documentation site
4. **Redirect**: Returns user to their originally requested page

### 3. Session Management
- Sessions are managed entirely client-side using Supabase's built-in session handling
- No server-side cookies or middleware authentication
- Sessions persist across browser tabs and page refreshes

## Technical Implementation

### Components

#### `/pages/login.tsx`
- Handles user authentication form
- Validates credentials with Supabase Auth
- Verifies user has `developer` role in database
- Redirects to requested page after successful login

#### `/pages/_app.tsx`
- Wraps all pages with authentication logic
- Checks for valid Supabase session on page load
- Verifies user role on every route change
- Redirects to login if session is invalid or user lacks developer role

#### `/middleware.ts`
- Minimal middleware that allows all requests through
- Authentication is handled client-side for better Supabase integration
- Could be enhanced for server-side validation if needed

### Database Schema

The authentication system relies on the `user_roles` table:

```sql
CREATE TABLE user_roles (
  id SERIAL PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  role TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);
```

**Required Role**: Users must have `role = 'developer'` to access documentation.

### Configuration

The system uses the same Supabase project as the main dashboard:

```typescript
// lib/supabase.ts
const SUPABASE_URL = "https://cdwtsrzshpotkfbyyyjk.supabase.co"
const SUPABASE_PUBLISHABLE_KEY = "eyJ..."
```

## User Experience

### Login Flow
1. User navigates to any documentation page
2. If not authenticated, redirected to `/login?redirect=%2Foriginal-path`
3. User enters credentials (same as main dashboard)
4. System validates credentials and checks developer role
5. If successful, user is redirected to original page
6. If role check fails, user sees error and is signed out

### Error Handling
- **Invalid credentials**: Shows Supabase auth error message
- **Missing role**: "User role not found. Please contact administrator."
- **Insufficient permissions**: "Developer access required for documentation"
- **Network errors**: "Authentication failed"

### Session Persistence
- Sessions persist across browser restarts
- Users stay logged in until they explicitly sign out or session expires
- Session state is shared with the main dashboard (same Supabase project)

## Security Features

### Role-Based Access Control
- Only users with `developer` role can access documentation
- Role is verified on every page load and route change
- Invalid or expired sessions automatically redirect to login

### Session Security
- Uses Supabase's built-in JWT token system
- Tokens are automatically refreshed by Supabase client
- Sessions expire according to Supabase project settings

### Input Validation
- Email format validation on login form
- Password requirement enforcement
- SQL injection protection via Supabase ORM

## Development Notes

### Local Development
- Authentication is bypassed in local development (optional)
- Same Supabase project used as production for consistency
- No special configuration needed for development

### Deployment
- No server-side authentication configuration required
- Client-side only approach simplifies deployment
- Environment variables handled by Supabase client configuration

### Troubleshooting

**Common Issues:**
1. **Infinite redirect loops**: Usually caused by middleware conflicts (resolved by using client-side auth only)
2. **Session not persisting**: Supabase client configuration or browser storage issues
3. **Role check failing**: User not in `user_roles` table or incorrect role value

**Debug Steps:**
1. Check browser console for authentication errors
2. Verify user exists in Supabase Auth dashboard
3. Confirm user has `developer` role in `user_roles` table
4. Test with browser developer tools to inspect session storage
# CoAP Bridge Deployment & Management

The CoAP bridge is a Python 3.11 server running on Fly.io that processes IoT device messages and forwards data to Supabase. This guide covers deployment, monitoring, and maintenance procedures.

## What the CoAP Bridge Does

The bridge server performs these key functions:

1. **Receives CoAP Messages**: Listens on UDP port 5683 for device communications
2. **Parses Protocol Buffers**: Decodes binary protobuf messages into structured data
3. **Data Processing**: Extracts device config, activity, reboot, and sensor data
4. **Format Conversion**: Transforms protobuf data to JSON for Supabase
5. **Secure Forwarding**: Sends HTTP requests to Supabase Edge Functions with HMAC signatures

## Architecture Overview

```
IoT Device (CoAP/UDP) â†’ Fly.io Container â†’ Supabase Edge Function
     â†“                       â†“                      â†“
Protobuf Message    Python Processing        JSON + HMAC
```

### Core Components

- **main.py**: CoAP server using aiocoap library
- **store_to_supabase.py**: HTTP client for Supabase integration  
- **uplink_pb2.py**: Generated protobuf message definitions
- **Dockerfile**: Container configuration for Fly.io deployment

## Deployment Procedures

### Prerequisites

1. **Fly.io CLI**: Install and authenticate with `flyctl auth login`
2. **Access**: You need access to the `flyio-nbiot` app on Fly.io
3. **Environment**: Ensure environment variables are configured

### Initial Deployment

```bash
# Clone and navigate to CoAP bridge directory
cd "C:\Programming Projects\MOC-IoT\CoAP-bridge"

# Deploy to Fly.io (builds and deploys container)
flyctl deploy

# Verify deployment
flyctl status
flyctl logs
```

### Updating the Server

```bash
# Make code changes to Python files
# Build and deploy updated container
flyctl deploy

# Monitor deployment
flyctl logs --app flyio-nbiot
```

### Environment Configuration

The server requires these environment variables set in Fly.io:

```bash
# View current environment variables  
flyctl secrets list

# Set required secrets
flyctl secrets set SUPABASE_URL="https://cdwtsrzshpotkfbyyyjk.supabase.co"
flyctl secrets set SUPABASE_API_KEY="[SERVICE_ROLE_KEY]"

# Optional: Set logging level
flyctl secrets set LOG_LEVEL="DEBUG"
```

**Critical**: The `SUPABASE_API_KEY` must be the **service role key** (not anon key) for database write permissions.

## Application Configuration

### fly.toml Configuration

```toml
app = 'flyio-nbiot'
primary_region = 'arn'

[build]
  dockerfile = "Dockerfile"

[[services]]
  protocol = "udp"
  internal_port = 5683
  processes = ["app"]

  [[services.ports]]
    port = 5683

[[vm]]
  memory = '256mb'
  cpu_kind = 'shared'
  cpus = 1
```

### Dockerfile Configuration

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY . /app

RUN pip install --no-cache-dir -r requirements.txt

ENV PYTHONUNBUFFERED=1

CMD ["python", "main.py"]
```

## Monitoring and Troubleshooting

### Real-time Monitoring

```bash
# View live logs (most important for debugging)
flyctl logs --app flyio-nbiot

# View application status
flyctl status --app flyio-nbiot

# View resource usage
flyctl metrics --app flyio-nbiot

# SSH into running container (for debugging)
flyctl ssh console --app flyio-nbiot
```

### Log Analysis

The server uses structured logging with color coding:

- **ðŸŸ¢ INFO**: Successful message processing
- **ðŸŸ¡ WARNING**: Recoverable errors or retries
- **ðŸ”´ ERROR**: Failed operations requiring attention
- **ðŸ”µ DEBUG**: Detailed message content and parsing info

### Common Issues and Solutions

#### 1. Connection Refused Errors
```bash
# Check if app is running
flyctl status

# Restart if needed
flyctl machine restart [machine-id]

# View recent logs for startup errors
flyctl logs --app flyio-nbiot
```

#### 2. Supabase Connection Failures
```bash
# Verify environment variables are set
flyctl secrets list

# Test database connectivity
flyctl ssh console
# Inside container:
python3 -c "import os; print('URL:', os.getenv('SUPABASE_URL')); print('Key set:', bool(os.getenv('SUPABASE_API_KEY')))"
```

#### 3. Protobuf Parsing Errors
- **Symptom**: Logs show "Failed to parse protobuf message"
- **Cause**: Device sending invalid or outdated message format
- **Solution**: Check protobuf schema versions between firmware and server

#### 4. High Memory Usage
```bash
# Check memory usage
flyctl metrics --app flyio-nbiot

# Scale to larger instance if needed
flyctl scale memory 512 --app flyio-nbiot
```

## Maintenance Procedures

### Regular Maintenance Tasks

#### Weekly
- Review error logs: `flyctl logs --app flyio-nbiot | grep ERROR`
- Check memory/CPU usage: `flyctl metrics --app flyio-nbiot`
- Verify Supabase connectivity

#### Monthly  
- Review and rotate Supabase API keys if needed
- Update Python dependencies in requirements.txt
- Check for Fly.io platform updates

#### As Needed
- Update protobuf schemas when firmware changes
- Modify data processing logic in store_to_supabase.py
- Adjust logging levels based on debugging needs

### Updating Dependencies

```bash
# Update requirements.txt with new versions
# Test locally first, then deploy
flyctl deploy

# Monitor for any issues after deployment
flyctl logs --app flyio-nbiot
```

### Scaling Operations

```bash
# Scale CPU/memory
flyctl scale memory 512 --app flyio-nbiot
flyctl scale cpu 2 --app flyio-nbiot

# Add more instances (if needed for high load)
flyctl scale count 2 --app flyio-nbiot
```

## Development and Testing

### Local Development

```bash
# Set environment variables locally
export SUPABASE_URL="https://cdwtsrzshpotkfbyyyjk.supabase.co"  
export SUPABASE_API_KEY="[YOUR_SERVICE_KEY]"

# Install dependencies
pip install -r requirements.txt

# Run locally (listens on localhost:5683)
python main.py
```

### Testing CoAP Endpoint

```bash
# Install CoAP client tool
pip install aiocoap[all]

# Test endpoint with simple message
echo "test" | coap-client -m POST coap://localhost:5683/data

# For production testing
echo "test" | coap-client -m POST coap://flyio-nbiot.fly.dev:5683/data
```

## Security Considerations

### Network Security
- **UDP Port**: Only port 5683 is exposed externally
- **No Authentication**: Devices connect without credentials (validated by message content)
- **Rate Limiting**: Consider implementing if abuse becomes an issue

### Application Security
- **Environment Variables**: All secrets stored in Fly.io secrets (not in code)
- **HMAC Signatures**: All outbound requests to Supabase are signed
- **Input Validation**: Protobuf schema provides message validation
- **Error Handling**: No sensitive data exposed in error messages

### Operational Security
- **Access Control**: Only authorized developers can deploy to Fly.io
- **Logging**: Be careful not to log sensitive device information
- **Dependencies**: Regularly update Python packages for security fixes
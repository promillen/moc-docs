# Dashboard Integration

The MOC-IoT dashboard is a React TypeScript application that provides real-time monitoring and management of IoT devices. This section covers the frontend architecture, real-time data flow, and integration with the backend systems.

## Dashboard Overview

### Technology Stack
- **React 18** with TypeScript and Vite for fast development
- **shadcn-ui** components built on Radix UI primitives
- **Tailwind CSS** for styling and responsive design
- **TanStack Query** for server state management and caching
- **Leaflet** for interactive device location mapping
- **Recharts** for sensor data visualization
- **Supabase Client** for database access and real-time subscriptions

### Project Structure

```
Dashboard/src/
├── components/
│   ├── ui/                  # shadcn-ui component library
│   ├── AppSidebar.tsx       # Main navigation sidebar
│   ├── DeviceList.tsx       # Device management interface
│   ├── MapView.tsx          # Interactive device location map
│   ├── UserManagement.tsx   # Admin user controls
│   └── DeviceLogViewer.tsx  # Device activity logs
├── hooks/
│   ├── useAuth.tsx          # Authentication state management
│   └── useUserRole.tsx      # Role-based permissions
├── integrations/supabase/
│   ├── client.ts            # Supabase client configuration
│   └── types.ts             # Generated TypeScript types
├── pages/
│   ├── Dashboard.tsx        # Main dashboard layout
│   └── Auth.tsx             # Login/authentication page
└── App.tsx                  # Root application component
```

## Real-time Data Architecture

### Supabase Integration

The dashboard connects to the same Supabase instance used by the CoAP bridge:

```typescript
// integrations/supabase/client.ts
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://cdwtsrzshpotkfbyyyjk.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
```

### Real-time Subscriptions

The dashboard uses Supabase's real-time features to update the UI immediately when devices send new data:

```typescript
// Example: Real-time device updates
useEffect(() => {
  const subscription = supabase
    .channel('device-updates')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'sensor_data',
      filter: 'data_type=eq.location'
    }, (payload) => {
      // Update map markers immediately
      updateDeviceLocation(payload.new);
    })
    .on('postgres_changes', {
      event: 'UPDATE', 
      schema: 'public',
      table: 'device_config'
    }, (payload) => {
      // Update device status
      updateDeviceStatus(payload.new);
    })
    .subscribe();

  return () => subscription.unsubscribe();
}, []);
```

## Core Components

### 1. Device List Component

Displays all devices with filtering, search, and management capabilities:

```typescript
interface DeviceConfig {
  devid: string;
  name: string;
  iccid: string;
  heartbeat_interval: number;
  sw_version: string;
  hw_version: string;
  application_mode: string;
  device_data_updated_at: string;
  last_seen: string;
  created_at: string;
  battery_level: number;
}

const DeviceList = () => {
  const { data: devices, isLoading } = useQuery({
    queryKey: ['devices'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('device_config')
        .select('*')
        .order('last_seen', { ascending: false });
      
      if (error) throw error;
      return data;
    },
    refetchInterval: 30000, // Refresh every 30 seconds
  });

  return (
    <div className="space-y-4">
      {devices?.map((device) => (
        <DeviceCard key={device.devid} device={device} />
      ))}
    </div>
  );
};
```

### 2. Interactive Map Component

Uses Leaflet to display device locations with real-time updates:

```typescript
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import MarkerClusterGroup from 'react-leaflet-markercluster';

const MapView = () => {
  const { data: locations } = useQuery({
    queryKey: ['device-locations'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('sensor_data')
        .select(`
          devid,
          data,
          created_at,
          device_config(name)
        `)
        .eq('data_type', 'location')
        .order('created_at', { ascending: false });
        
      if (error) throw error;
      return data;
    }
  });

  // Real-time location updates
  useEffect(() => {
    const subscription = supabase
      .channel('location-updates')
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public', 
        table: 'sensor_data',
        filter: 'data_type=eq.location'
      }, (payload) => {
        // Add new location marker immediately
        addLocationMarker(payload.new);
      })
      .subscribe();

    return () => subscription.unsubscribe();
  }, []);

  return (
    <MapContainer center={[55.6761, 12.5683]} zoom={10}>
      <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
      <MarkerClusterGroup>
        {locations?.map((location) => (
          <Marker
            key={`${location.devid}-${location.created_at}`}
            position={[location.data.lat, location.data.lng]}
          >
            <Popup>
              <div>
                <h3>{location.device_config?.name || location.devid}</h3>
                <p>Accuracy: {location.data.accuracy}m</p>
                <p>Last seen: {formatDate(location.created_at)}</p>
              </div>
            </Popup>
          </Marker>
        ))}
      </MarkerClusterGroup>
    </MapContainer>
  );
};
```

### 3. Authentication and Permissions

Role-based access control with Supabase Auth:

```typescript
// hooks/useAuth.tsx
export const useAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (event, session) => {
        setUser(session?.user ?? null);
        setLoading(false);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  return { user, loading };
};

// hooks/useUserRole.tsx  
export const useUserRole = () => {
  const { user } = useAuth();
  
  const { data: userRole, isLoading } = useQuery({
    queryKey: ['user-role', user?.id],
    queryFn: async () => {
      if (!user) return null;
      
      const { data, error } = await supabase
        .from('user_roles')
        .select('role')
        .eq('user_id', user.id)
        .single();
        
      if (error) throw error;
      return data.role;
    },
    enabled: !!user,
  });

  return {
    role: userRole,
    isAdmin: userRole === 'admin',
    isModerator: ['admin', 'moderator'].includes(userRole),
    isLoading
  };
};
```

## Data Visualization

### Device Status Dashboard

```typescript
const DeviceStatusChart = ({ deviceId }: { deviceId: string }) => {
  const { data: activityData } = useQuery({
    queryKey: ['device-activity', deviceId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('activity')
        .select('*')
        .eq('devid', deviceId)
        .order('created_at', { ascending: false })
        .limit(24); // Last 24 hours
        
      if (error) throw error;
      return data;
    }
  });

  return (
    <ResponsiveContainer width="100%" height={300}>
      <BarChart data={activityData}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="created_at" />
        <YAxis />
        <Tooltip />
        <Legend />
        <Bar dataKey="sleep_duration" stackId="a" fill="#8884d8" />
        <Bar dataKey="modem_duration" stackId="a" fill="#82ca9d" />
        <Bar dataKey="gnss_duration" stackId="a" fill="#ffc658" />
        <Bar dataKey="wifi_duration" stackId="a" fill="#ff7300" />
      </BarChart>
    </ResponsiveContainer>
  );
};
```

### Location History Tracking

```typescript
const LocationHistory = ({ deviceId }: { deviceId: string }) => {
  const { data: locationHistory } = useQuery({
    queryKey: ['location-history', deviceId],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('sensor_data')
        .select('data, created_at')
        .eq('devid', deviceId)
        .eq('data_type', 'location')
        .order('created_at', { ascending: false })
        .limit(100);
        
      if (error) throw error;
      return data.map(item => ({
        ...item.data,
        timestamp: item.created_at
      }));
    }
  });

  return (
    <ResponsiveContainer width="100%" height={400}>
      <LineChart data={locationHistory}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis dataKey="timestamp" />
        <YAxis yAxisId="lat" orientation="left" />
        <YAxis yAxisId="lng" orientation="right" />
        <Tooltip />
        <Legend />
        <Line yAxisId="lat" type="monotone" dataKey="lat" stroke="#8884d8" />
        <Line yAxisId="lng" type="monotone" dataKey="lng" stroke="#82ca9d" />
      </LineChart>
    </ResponsiveContainer>
  );
};
```

## Performance Optimizations

### Query Caching Strategy

```typescript
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 30 * 1000, // 30 seconds
      cacheTime: 5 * 60 * 1000, // 5 minutes
      refetchOnWindowFocus: false,
      retry: (failureCount, error) => {
        // Don't retry auth errors
        if (error?.message?.includes('JWT')) return false;
        return failureCount < 3;
      }
    }
  }
});
```

### Real-time Update Batching

```typescript
// Batch location updates to avoid excessive re-renders
const useBatchedLocationUpdates = () => {
  const [pendingUpdates, setPendingUpdates] = useState([]);
  
  useEffect(() => {
    const timer = setInterval(() => {
      if (pendingUpdates.length > 0) {
        // Apply all pending updates at once
        applyLocationUpdates(pendingUpdates);
        setPendingUpdates([]);
      }
    }, 1000); // Batch updates every second
    
    return () => clearInterval(timer);
  }, [pendingUpdates]);
  
  const addLocationUpdate = (update) => {
    setPendingUpdates(prev => [...prev, update]);
  };
  
  return { addLocationUpdate };
};
```

### Lazy Loading and Code Splitting

```typescript
// Lazy load heavy components
const MapView = lazy(() => import('./components/MapView'));
const DeviceLogViewer = lazy(() => import('./components/DeviceLogViewer'));

const Dashboard = () => {
  return (
    <Suspense fallback={<LoadingSkeleton />}>
      {activeView === 'map' && <MapView />}
      {activeView === 'logs' && <DeviceLogViewer />}
    </Suspense>
  );
};
```

## Development and Deployment

### Local Development Setup

```bash
# Navigate to dashboard directory
cd "C:\Programming Projects\MOC-IoT\Dashboard"

# Install dependencies
npm install

# Start development server
npm run dev

# Access at http://localhost:8080
```

### Build and Deployment

```bash
# Production build
npm run build

# Development build (with source maps)
npm run build:dev

# Preview production build
npm run preview

# Lint code
npm run lint
```

### Environment Configuration

The dashboard uses environment variables for configuration:

```typescript
// vite-env.d.ts
interface ImportMetaEnv {
  readonly VITE_SUPABASE_URL: string;
  readonly VITE_SUPABASE_ANON_KEY: string;
}
```

### Testing Integration

```typescript
// Example integration test
describe('Device List Integration', () => {
  test('displays devices from Supabase', async () => {
    // Mock Supabase response
    const mockDevices = [
      { devid: '12345', name: 'Test Device', last_seen: new Date() }
    ];
    
    render(<DeviceList />);
    
    // Verify devices are displayed
    await waitFor(() => {
      expect(screen.getByText('Test Device')).toBeInTheDocument();
    });
  });
});
```

## Troubleshooting

### Common Issues

1. **Real-time subscriptions not working**
   - Check Supabase connection
   - Verify RLS policies allow subscriptions
   - Monitor browser network tab for WebSocket connections

2. **Authentication failures**
   - Verify Supabase keys in client configuration
   - Check user roles in database
   - Clear browser storage and retry login

3. **Map not loading**
   - Verify Leaflet CSS is imported
   - Check for JavaScript errors in console
   - Ensure location data has valid lat/lng coordinates

4. **Performance issues with large datasets**
   - Implement pagination for device lists
   - Add filtering to reduce query sizes
   - Use virtual scrolling for long lists
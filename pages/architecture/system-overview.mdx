# System Overview

The MOC-IoT system is a distributed IoT device management platform designed for monitoring and tracking devices via cellular networks. The architecture prioritizes reliability, scalability, and real-time data processing.

## High-Level Architecture

```mermaid
flowchart TD
    A[IoT Device<br/>NB-IoT/LTE] -->|CoAP/UDP:5683| B[Fly.io Server<br/>flyio-nbiot.fly.dev]
    B -->|HTTP/HTTPS<br/>HMAC Auth| C[Supabase Edge Function<br/>ingest-sensor-data]
    C --> D[HERE Positioning API]
    C --> E[PostgreSQL Database<br/>cdwtsrzshpotkfbyyyjk.supabase.co]
    E -->|Real-time subscriptions| F[React Dashboard<br/>TypeScript + shadcn-ui]
    
    G[(Tables)]
    E --> G
    G --> H[device_config]
    G --> I[sensor_data] 
    G --> J[activity]
    G --> K[reboot]
    G --> L[user_roles]
```

## Component Responsibilities

### 1. IoT Devices
- **Communication**: Send data via CoAP protocol over NB-IoT/LTE cellular networks
- **Message Format**: Protocol Buffers for efficient serialization
- **Target**: `flyio-nbiot.fly.dev:5683` (UDP)
- **Authentication**: Devices authenticated via message content validation

### 2. CoAP Bridge (Fly.io Server)
- **Location**: `flyio-nbiot` app on Fly.io platform
- **Runtime**: Python 3.11 with asyncio
- **Primary Function**: Receive CoAP messages, parse Protocol Buffers, forward to Supabase
- **Libraries**: aiocoap, aiohttp, protobuf, colorlog
- **Configuration**: Environment variables for Supabase connection

### 3. Supabase Backend
- **Edge Functions**: Handle HTTP requests from CoAP bridge
- **Database**: PostgreSQL with Row Level Security (RLS)
- **Real-time**: WebSocket subscriptions for live updates
- **Location Services**: Integration with HERE Positioning API
- **Project**: `cdwtsrzshpotkfbyyyjk.supabase.co`

### 4. React Dashboard
- **Framework**: React 18 + TypeScript + Vite
- **UI Components**: shadcn-ui with Tailwind CSS
- **State Management**: TanStack Query for server state
- **Mapping**: Leaflet for interactive device locations
- **Authentication**: Supabase Auth with role-based access

## Technology Choices

### Why CoAP?
- **Lightweight**: Minimal overhead for battery-powered devices
- **UDP-based**: Suitable for cellular networks with intermittent connectivity
- **Standardized**: RFC 7252 specification ensures interoperability

### Why Protocol Buffers?
- **Efficiency**: 3-10x smaller than JSON for typical IoT payloads
- **Schema Evolution**: Backward and forward compatibility for firmware updates
- **Language Support**: Generated code for Python (server) and C++ (firmware)

### Why Fly.io?
- **Global Edge**: Servers deployed close to cellular network gateways
- **UDP Support**: Native support for CoAP protocol requirements
- **Container Platform**: Easy deployment and scaling of Python applications
- **Cost Effective**: Pay-per-use model suitable for IoT workloads

### Why Supabase?
- **Real-time**: Built-in WebSocket subscriptions for dashboard updates
- **Edge Functions**: Serverless compute for data processing
- **PostgreSQL**: Flexible JSON storage for diverse sensor data
- **Authentication**: Built-in auth system with role-based access control

## Data Flow Sequences

### Device Heartbeat Flow

```mermaid
sequenceDiagram
    participant Device as IoT Device
    participant Fly as Fly.io Server
    participant Edge as Edge Function
    participant DB as Database
    participant Dashboard as Dashboard

    Device->>Fly: CoAP POST /data<br/>Protobuf: {config, activity, reboot}
    Note right of Fly: Parse protobuf<br/>Extract device data
    Fly->>Edge: HTTP POST<br/>JSON + HMAC signature
    Note right of Edge: Verify HMAC<br/>Validate payload
    Edge->>DB: INSERT device_config<br/>INSERT activity, reboot
    DB-->>Dashboard: Real-time WebSocket<br/>notification
    Note right of Dashboard: Update device status<br/>Refresh UI components
```

### Location Data Processing

```mermaid
sequenceDiagram
    participant Device as IoT Device
    participant Fly as Fly.io Server
    participant Edge as Edge Function
    participant HERE as HERE API
    participant DB as Database
    participant Dashboard as Dashboard

    Device->>Fly: CoAP POST /data<br/>Protobuf: {wifi[], cells[], gnss}
    Fly->>Edge: HTTP POST<br/>WiFi/Cell data + HMAC
    Edge->>HERE: Position request<br/>{wlan: [...], cell: [...]}
    HERE-->>Edge: Location response<br/>{lat, lng, accuracy}
    Edge->>DB: INSERT sensor_data<br/>type: 'location'
    DB-->>Dashboard: Real-time update
    Note right of Dashboard: Update map markers<br/>Show new device location
```

### Sensor Data Processing (Non-Geolocation)

```mermaid
sequenceDiagram
    participant Device as Soil Sensor Device
    participant Fly as Fly.io Server
    participant Edge as Edge Function
    participant DB as Database
    participant Dashboard as Dashboard

    Device->>Fly: CoAP POST /data<br/>Protobuf: {temperature, humidity, npk, ph}
    Note right of Fly: Parse sensor data<br/>No location processing
    Fly->>Edge: HTTP POST<br/>Sensor data + HMAC
    Note right of Edge: Skip HERE API<br/>Direct storage
    Edge->>DB: INSERT sensor_data<br/>type: 'soil_data'
    DB-->>Dashboard: Real-time update
    Note right of Dashboard: Update sensor charts<br/>No map changes
```

## Data Processing Logic

### Message Type Routing
The Edge Function automatically determines how to process incoming data based on message content:

#### Location Data (Uses HERE API)
- **Triggers**: Messages containing `wifi[]`, `cells[]`, or `gnss` data
- **Processing**: Sent to HERE Positioning API for coordinate calculation
- **Storage**: Results stored as `sensor_data` with `data_type: 'location'`
- **Dashboard Impact**: Updates device location on map

#### Sensor Data (Direct Storage)
- **Triggers**: Messages containing sensor readings (temperature, humidity, soil data, etc.)
- **Processing**: Direct validation and storage, no external APIs
- **Storage**: Stored as `sensor_data` with appropriate `data_type` (e.g., 'soil_data', 'temperature')
- **Dashboard Impact**: Updates sensor charts and readings

#### Configuration Data (Device Management)
- **Triggers**: Messages containing device configuration updates
- **Processing**: Updates device metadata and settings
- **Storage**: Updates `device_config` table
- **Dashboard Impact**: Refreshes device status and information

### Response Times
- **CoAP Processing**: < 50ms average
- **Edge Function**: < 200ms (with HERE API), < 50ms (sensor data only)
- **Database Operations**: < 100ms for typical queries
- **Dashboard Updates**: Real-time (< 1 second)

## Security Architecture

### Device-to-Server Security
- **Device Identification**: Devices identified by `dev_id` field in protobuf payload
- **Message Integrity**: Payload validation via protobuf schema
- **Network Security**: Cellular network encryption (LTE/NB-IoT)

### Server-to-Server Security
- **HMAC Authentication**: All Fly.io â†’ Supabase requests signed with shared secret
- **TLS Encryption**: All HTTP/HTTPS communications encrypted
- **Environment Isolation**: Secrets stored in Fly.io and Supabase environments

### Dashboard Security
- **User Authentication**: Email/password via Supabase Auth
- **Role-Based Access**: Developer, admin, moderator, user roles with different permissions
- **Row Level Security**: Database-level access control policies
- **Session Management**: JWT tokens with configurable expiration